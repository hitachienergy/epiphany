# Serverspec tests require $HOME/.kube/config on kubernetes_master hosts.
# This playbook reverts temporary changes.

- hosts: kubernetes_master
  gather_facts: false
  become_method: sudo
  vars:
    revert_file_path: ~/.copy-kubeconfig-revert.yml
  tasks:
    - name: Check if revert file exists
      stat:
        path: "{{ revert_file_path }}"
        get_attributes: false
        get_checksum: false
        get_mime: false
      register: stat_revert_file

    - name: Revert temporary changes
      when: stat_revert_file.stat.exists
      block:
        - name: Load revert file
          slurp:
            src: "{{ revert_file_path }}"
          register: slurp_revert_file

        - name: Set paths to revert
          set_fact:
            kubeconfig_paths: "{{ slurp_revert_file['content'] | b64decode | from_yaml }}"

        - name: Remove paths
          file:
            path: "{{ item.path }}"
            state: absent
          loop_control:
            label: "{{ item.path }}"
          loop: "{{ kubeconfig_paths | selectattr('stat.exists', '==', false) }}"

        - name: Remove revert file
          file:
            path: "{{ revert_file_path }}"
            state: absent
