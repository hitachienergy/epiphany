---
- delegate_to: "{{ kubernetes_common.automation_designated_master }}"
  block:
    - name: Get token from master
      shell: |
        kubeadm token list \
        | grep -w authentication \
        | grep -vwi invalid \
        | awk '{print $1}' \
        | head -1
      args:
        executable: /bin/bash
      register: kubeadm_valid_token
      until: (kubeadm_valid_token is success) and (kubeadm_valid_token.stderr | length == 0)
      retries: 60
      delay: 5
      changed_when: false

    - name: Create new token
      shell: |
        kubeadm token create \
          --ttl 4h \
          --description "Token generated by Epiphany for 'kubeadm join'."
      args:
        executable: /bin/bash
      register: kubeadm_new_token
      when: not kubeadm_valid_token.stdout

    - name: Get CA key hash
      shell: |
        openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt \
        | openssl rsa -pubin -outform der 2>/dev/null \
        | openssl dgst -sha256 -hex \
        | sed 's/^.* //'
      args:
        executable: /bin/bash
      register: kubeadm_cert_hash
      changed_when: false

- name: Remember join token and cert hash
  set_fact:
    kubernetes_common: >-
      {{ kubernetes_common | default({}) | combine(set_fact, recursive=true) }}
  vars:
    set_fact:
      kubeadm_join_token: >-
        {{ kubeadm_valid_token.stdout if kubeadm_valid_token.stdout else kubeadm_new_token.stdout_lines[-1] }}
      kubeadm_cert_hash: >-
        {{ kubeadm_cert_hash.stdout }}
