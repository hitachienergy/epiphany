---
- name: Check if enabled applications are supported for the architecture
  block:
    - name: Include application vars from applications role
      include_vars:
        file: roles/applications/vars/main.yml
        name: k8s_apps

    - name: Check if enabled applications are supported for the architecture
      assert:
        that: _unsupported_enabled_apps | length == 0
        fail_msg: >-
          Following application(s) are not supported for {{ _k8s_arch }} and cannot be installed:
            {{ _unsupported_enabled_apps | map(attribute='name') | list | join(', ') }}
        success_msg: "All enabled applications are supported for {{ _k8s_arch }}"
        quiet: true
      vars:
        _k8s_arch: >-
          {{ hostvars[groups['kubernetes_master'][0]]['ansible_architecture'] }}
        _defined: >-
          {{ k8s_apps.specification.applications | selectattr('enabled', 'defined') | list }}
        _undefined: >-
          {{ k8s_apps.specification.applications | selectattr('enabled', 'undefined') | list }}
        _enabled_apps: >-
          {{ (_defined | selectattr('enabled') | list) + _undefined }}
        _unsupported_enabled_apps: >-
          {{ _enabled_apps | selectattr('name', 'in', unsupported_apps[_k8s_arch]) | list }}
  run_once: true
  delegate_to: localhost
  when:
    - groups.kubernetes_master is defined
    - groups.kubernetes_master | length > 0
    - "'applications' in roles_with_generated_vars" # there is a case with disabled applications by custom feature mapping

- name: Kubernetes checks
  block:
    - name: Check if K8s node has enough memory
      assert:
        that: ansible_memtotal_mb >= 2048
        fail_msg: >-
          At least 2 GB of RAM per machine is required.
          Check documentation: https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#before-you-begin.
        quiet: true

    - name: Check if K8s node has enough CPUs
      assert:
        that: ansible_processor_vcpus >= 2
        fail_msg: >-
          At least 2 CPUs is required.
          Check documentation: https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#before-you-begin.
        quiet: true

    - name: Get K8s cluster version
      command: swapon --show --noheadings
      register: swapon
      changed_when: false

    - name: Check if swap is disabled on K8s node
      assert:
        that: swapon.stdout_lines | length == 0
        fail_msg: >-
          Swap must be disabled in order for the kubelet to work properly.
          Check documentation: https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#before-you-begin.
        quiet: true
  when:
    - groups.kubernetes_master is defined
    - groups.kubernetes_master | length > 0
    - "['kubernetes_master', 'kubernetes_node'] | intersect(group_names) | length > 0"

- name: PostgreSQL checks
  include_tasks: roles/postgresql/tasks/preflight/apply.yml
  when:
    - groups.postgresql is defined
    - groups.postgresql | length > 0
