---
- name: Check routing configuration
  shell: ip route show default 0.0.0.0/0
  register: default_routing_configuration_number
  args:
    executable: /bin/bash

- name: Assert any default routing configuration exists
  assert:
    that: default_routing_configuration_number.stdout_lines | length != 0
    fail_msg: >-
      No default routing configuration. At least one default route is needed,
      read more in troubleshooting document
    quiet: true

- name: Checks for multiplied default routing configurations
  when: default_routing_configuration_number.stdout_lines | length > 1
  block:
    - name: Get metric parameters
      shell: |-
        set -o pipefail && \
        ip route show default 0.0.0.0/0 | awk '{if (! /metric/) print 0; else for (x=1;x<NF;x++) if ($x == "metric") print $(x+1) }'
      register: default_routing_configuration_metric_value
      args:
        executable: /bin/bash

    - name: Compare two most prioritized routes if they have different metrics
      assert:
        that: "default_routing_configuration_metric_value.stdout_lines[0] != default_routing_configuration_metric_value.stdout_lines[1]"
        fail_msg:  >-
          There is more than one default route with duplicated metrics value.
          Check routing configuration, read more in troubleshooting document

- include_vars:
    file: roles/common/vars/main.yml
    name: common_vars

- name: Validate if ansible_default_ipv4.address matches address from inventory
  when:
    - common_vars.provider == "any"
    - common_vars.specification.cloud is undefined
  assert:
    that: ansible_default_ipv4.address == hostvars[inventory_hostname].ansible_host
    fail_msg:  >-
      ansible_default_ipv4.address is {{ ansible_default_ipv4.address }} but inventory uses ip: {{ hostvars[inventory_hostname].ansible_host }}.
      Check default routing configuration, read more in troubleshooting document
    quiet: true
