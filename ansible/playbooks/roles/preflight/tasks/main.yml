---
- include_tasks: check-user.yml

- name: Check if components are supported for architecture
  vars:
    architecture: "{{ hostvars[groups.all[0]]['ansible_architecture'] }}"
    os_distro: "{{ hostvars[groups.all[0]]['ansible_distribution'] }}"
  block:
    - name: Set unsupported_components_checklist fact
      delegate_to: localhost
      become: false
      set_fact:
        unsupported_components_checklist: "{{ unsupported_roles | selectattr('distro','equalto', os_distro)
                                                                | selectattr('arch','equalto', architecture)
                                                                | map(attribute='roles') | list | flatten
                                                                | intersect(group_names) }}"

    - name: Check if components are supported for current architecture
      delegate_to: localhost
      become: false
      assert:
        that: unsupported_components_checklist | length == 0
        fail_msg: >-
          The following components in inventory are not supported for {{ architecture }} architecture on {{ os_distro }} OS:
          {{ unsupported_components_checklist | join(', ') }}.
          If the components are not necessary, you may remove them from the feature-mapping
          (see https://github.com/epiphany-platform/epiphany/blob/develop/docs/home/howto/CLUSTER.md#how-to-create-custom-cluster-components).
        success_msg: All components supported for {{ architecture }} architecture
        quiet: true

- include_tasks: check-os.yml

- name: Check routing configuration
  shell: |-
    set -o pipefail && \
    ip route show default 0.0.0.0/0
  register: default_routing_configuration_number
  failed_when: default_routing_configuration_number.rc != 0
  args:
    executable: /bin/bash

- name: Assert only one default routing configuration exists
  assert:
    that: default_routing_configuration_number.stdout_lines | length == 1
    fail_msg: >-
      Too many or none default routing configuration. Check default routing,
      read more in troubleshooting document
    quiet: true

- include_vars:
    file: roles/common/vars/main.yml
    name: common_vars

- name: Validate if ansible_default_ipv4.address matches address from inventory
  when:
    - common_vars.provider == "any"
    - common_vars.specification.cloud is undefined
  assert:
    that: ansible_default_ipv4.address == hostvars[inventory_hostname].ansible_host
    fail_msg:  >-
      ansible_default_ipv4.address is {{ ansible_default_ipv4.address }} but inventory uses ip: {{ hostvars[inventory_hostname].ansible_host }}.
      Check default routing configuration, read more in troubleshooting document
    quiet: true

- include_tasks: apply.yml
  when: not is_upgrade_run

- include_tasks: upgrade.yml
  when: is_upgrade_run

- import_role:
    name: preflight_facts
    tasks_from: store

- import_role:
    name: preflight_facts
    tasks_from: assert

- name: Wait for epiphany-lvm-merge.service to finish  # to avoid 'Read-only file system' error
  when: ansible_os_family == "RedHat"
  block:
    - name: Check if epiphany-lvm-merge.service exists  # exists only on Azure
      service_facts: null

    - name: Wait for epiphany-lvm-merge.service to finish
      when:
        - ansible_facts.services['epiphany-lvm-merge.service'] is defined
        - ansible_facts.services['epiphany-lvm-merge.service'].status != "disabled"
      wait_for: # at the end service disables itself so symlink is removed
        path: /etc/systemd/system/default.target.wants/epiphany-lvm-merge.service
        state: absent
        timeout: 300
