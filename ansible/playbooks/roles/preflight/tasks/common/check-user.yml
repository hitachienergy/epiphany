---
- name: Check if user has passwordless root privileges through sudo
  command: sudo -n -u root test -w /etc/sudoers
  changed_when: false
  failed_when: test_privileges.rc not in [0, 1]
  register: test_privileges

- name: Assert root privileges
  assert:
    that: test_privileges.rc == 0
    fail_msg: >-
      Privileges test failed. Remote user ({{ ansible_user }}) must be able to run commands as root through sudo
      without password.
      {% if test_privileges.stderr_lines | count -%}
      stderr_lines: {{ test_privileges.stderr_lines }}
      {%- endif -%}
    success_msg: User privileges passed
