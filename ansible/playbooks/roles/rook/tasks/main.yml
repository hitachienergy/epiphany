---
- name: Prepare configuration and upgrade/install Rook Helm chart
  when: specification.enabled
  become: true
  run_once: true
  block:
    - name: RedHat fix | Create helm's binary symlink
      file:
        src: "/usr/local/bin/helm"
        dest: "/usr/bin/helm"
        state: link
      when: ansible_os_family == 'RedHat'

    - name: Download Rook's Chart Files
      include_role:
        name: download
        tasks_from: download_file
      vars:
        file_name: "{{ item }}"
      loop:
        - "{{ rook_helm_chart_file_name }}"
        - "{{ rook_helm_cluster_chart_file_name }}"

    - name: Fail when configuration for operator and cluster chart are not defined
      fail:
        msg: "You need to configure operator_chart_values and cluster_chart_values when rook is enabled"
      when:
        - specification.operator_chart_values is not defined or
          specification.cluster_chart_values is not defined

    - name: Create configuration for operator Helm chart file (operator-custom-chart-values.yml)
      copy:
        content: "{{ specification.operator_chart_values }}"
        dest: "{{ download_directory }}/operator-custom-chart-values.yml"
        mode: preserve

    - name: Create configuration for cluster Helm chart file (cluster-custom-chart-values.yml)
      copy:
        content: "{{ specification.cluster_chart_values }}"
        dest: "{{ download_directory }}/cluster-custom-chart-values.yml"
        mode: preserve

    - name: Install Rook operator using Helm chart with values from operator-custom-chart-values.yml
      command: |
        helm -n {{ specification.rook_namespace }} upgrade --install \
          -f {{ download_directory }}/operator-custom-chart-values.yml \
          {{ rook_helm_chart_name }} \
          {{ download_directory }}/{{ rook_helm_chart_file_name }} --create-namespace

    - name: Create Rook cluster with values from cluster-custom-chart-values.yml
      command: |
        helm -n {{ specification.rook_namespace }} upgrade --install \
          --set operatorNamespace={{ specification.rook_namespace }} \
          -f {{ download_directory }}/cluster-custom-chart-values.yml \
          {{ rook_helm_cluster_chart_name }} \
          {{ download_directory }}/{{ rook_helm_cluster_chart_file_name }} --create-namespace
