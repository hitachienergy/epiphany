---
- name: Apply rolebinding to K8s for Prometheus
  become: false
  command: "kubectl apply -f {{ role_path }}/files/k8s-rolebinding.yml"
  run_once: true
  delegate_to: localhost

- name: Get Kubernetes bearer token for Prometheus
  become: false
  shell: |-
    kubectl get $(kubectl get secrets -n kube-system -o name | grep prometheus) \
      -n kube-system \
      -o jsonpath='{.data.token}'
  register: kube_token
  delegate_to: localhost
  run_once: true

- name: Create K8s token file
  copy:
    content: "{{ kube_token.stdout | b64decode }}"
    dest: "{{ specification.config_directory }}/k8s-token"
    owner: prometheus
    group: prometheus
    mode: u=r,go=
  no_log: true

- name: Load admin kubeconfig file
  delegate_to: localhost
  slurp:
    src: "{{ kubeconfig.local }}"
  register: admin_kubeconfig_file

- name: Get kubeconfig structure from file
  set_fact:
    admin_kubeconfig: "{{ admin_kubeconfig_file.content | b64decode | from_yaml }}"

- name: Create kubeconfig from template
  template:
    src: kubeconfig.yml.j2
    dest: "{{ specification.config_directory }}/kubeconfig"
    mode: u=r,go=

- name: Clear kubeconfig in memory
  set_fact:
    admin_kubeconfig_file: null
    admin_kubeconfig: null

- name: Clear kube_token in memory
  set_fact:
    kube_token: null
