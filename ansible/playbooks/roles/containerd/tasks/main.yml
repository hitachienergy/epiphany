---
- name: Remove Docker
  include_tasks: remove-docker.yml
  when:
    - is_upgrade_run
    - inventory_hostname not in groups.image_registry

- name: Install Containerd package
  package:
    name: containerd.io
    state: present
  module_defaults:
    yum: { lock_timeout: "{{ yum_lock_timeout }}" }

- name: Configure prerequisites
  include_tasks: configure-prerequisites.yml

- name: Configure Containerd
  include_tasks: configure-containerd.yml

- name: Append Containerd to kubelet config
  replace:
    path: /var/lib/kubelet/kubeadm-flags.env
    regexp: '(\")$'
    replace: ' --container-runtime=remote --container-runtime-endpoint=/run/containerd/containerd.sock"'
  notify:
    - Restart kubelet
  when: is_upgrade_run
