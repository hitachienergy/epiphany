---
- name: Ensure openssh packages are installed
  package:
    name: "{{ _packages[ansible_os_family] }}"
    state: present
  vars:
    _packages:
      Debian:
        - openssh-client
        - openssh-server
      RedHat:
        - openssh-clients
        - openssh-server

- name: Ensure sshd is started and enabled
  systemd:
    name: sshd
    enabled: true
    state: started

- name: Set getent_passwd fact
  getent:
    database: passwd
    key: "{{ username }}"
    split: ":"

- become_user: "{{ username }}"
  vars:
    home_dir: "{{ ansible_facts.getent_passwd[username][4] }}"
    ssh_key_path: "{{ home_dir }}/.ssh/id_ed25519"
    ssh_key_type: ed25519
  block:
    - name: Ensure {{ home_dir }}/.ssh directory exists
      file:
        path: "{{ home_dir }}/.ssh/"
        state: directory
        mode: u=rwx,go=

    # Backup is recommended for full_idempotence option:
    # https://docs.ansible.com/ansible/latest/collections/community/crypto/openssh_keypair_module.html#parameter-regenerate
    - name: Backup SSH key
      vars:
        timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
      block:
        - name: Check if file {{ ssh_key_path }} exists
          stat:
            path: "{{ ssh_key_path }}"
            get_attributes: false
            get_checksum: true
            get_mime: false
          register: ssh_key

        - when: ssh_key.stat.exists
          block:
            - name: Backup {{ ssh_key_path }}
              copy:
                src: "{{ ssh_key_path }}"
                dest: "{{ ssh_key_path }}-{{ timestamp }}"
                remote_src: true

            - name: Gather backup file stat
              stat:
                path: "{{ ssh_key_path }}-{{ timestamp }}"
                get_attributes: false
                get_checksum: true
                get_mime: false
              register: ssh_key_backup

            - name: Remove saved file if checksum is the same
              when: ssh_key.stat.checksum == ssh_key_backup.stat.checksum
              file:
                state: absent
                path: "{{ ssh_key_path }}-{{ timestamp }}"

    - name: Generate openssh keypair
      openssh_keypair:
        path: "{{ ssh_key_path }}"
        type: "{{ ssh_key_type }}"
        regenerate: full_idempotence
      register: openssh_keypair

    - name: Add public key to authorized_keys
      when: host != inventory_hostname
      delegate_to: "{{ host }}"
      authorized_key:
        user: "{{ username }}"
        state: present
        key: "{{ openssh_keypair.public_key }}"
      loop: "{{ groups['postgresql'] }}"
      loop_control:
        loop_var: host

    - name: Run ssh-keyscan
      when: host != inventory_hostname
      command: "ssh-keyscan {{ hostvars[host]['ansible_default_ipv4']['address'] }}"
      changed_when: false
      loop: "{{ groups['postgresql'] }}"
      loop_control:
        loop_var: host
      register: ssh_known_host_results

    - name: Ensure public keys are in {{ home_dir }}/.ssh/known_host
      when: host_info.host != inventory_hostname
      known_hosts:
        name: "{{ hostvars[host_info.host]['ansible_default_ipv4']['address'] }}"
        key: "{{ host_info.stdout }}"
        path: "{{ home_dir }}/.ssh/known_hosts"
      loop: "{{ ssh_known_host_results.results }}"
      loop_control:
        loop_var: host_info
        label: "{{ host_info.host }}"
