---
- import_tasks: gather-facts.yml

- name: Load images and run local registry
  when:
    - not custom_image_registry_address
    - inventory_hostname in target_image_registry_hostnames
  block:
    - name: Check if Docker is installed
      command: docker --version
      register: check_docker
      failed_when:
        - check_docker.rc not in [0, 2] # 2 means command not found
      changed_when: false

    # run docker role only if Docker is not installed, since it could upgrade it implicitly (before K8s)
    - name: Install and configure Docker
      import_role:
        name: docker
      when:
        - check_docker.rc != 0

    - name: Reconfigure Docker if necessary
      block:
        - name: Include get-registries.yml from docker role # this sets result
          include_role:
            name: docker
            tasks_from: get-registries

        - name: Reconfigure Docker # this restarts Docker daemon
          include_role:
            name: docker
            tasks_from: configure-docker
          when:
            - not image_registry_address in result.stdout
      when:
        - check_docker.rc == 0

    - name: Check if previous version registry is running and stop it if needed
      become: true
      block:
        - name: Get current running registry image name
          command: "{% raw %}docker ps --format '{{ .Image }}' -f 'name=registry' -f 'status=running'{% endraw %}"
          register: running_registry_image

        - name: Get current running registry container names
          command: "{% raw %}docker ps --format '{{ .Names }}' -f 'name=registry' -f 'status=running'{% endraw %}"
          register: running_registry_containers
          when:
            - running_registry_image.stdout
            - specification.registry_image.name != running_registry_image.stdout

        - set_fact:
            container_name: "{{ running_registry_containers.stdout }}"
          when: running_registry_containers.changed

        - block:
            - name: Stop previous version running registry container
              command: docker stop '{{ container_name }}'

            - name: Kill previous version running registry container
              command: docker rm '{{ container_name }}'
          when:
            - container_name is defined
            - container_name | length > 0
      when: is_upgrade_run

    - name: Load registry image
      include_tasks: load-image.yml
      vars:
        docker_image: "{{ specification.registry_image }}"

    - name: Check if registry is running
      become: true
      command: docker ps -q -f 'ancestor={{ specification.registry_image.name }}' -f 'status=running'
      register: current_registry_up_check
      changed_when: false

    # todo run registry with SSL - generate/copy certs, mount it to registry container
    - name: Run registry
      become: true
      command: >-
        docker run -d -e REGISTRY_HTTP_ADDR=0.0.0.0:5000 -p 5000:5000 --restart=always
        --name epiphany-registry {{ specification.registry_image.name }}
      when: current_registry_up_check.stdout | length == 0

    - name: Set images to load
      set_fact:
        generic_and_current_images: >-
          {{ specification.images_to_load[ansible_architecture].generic + specification.images_to_load[ansible_architecture].current }}
        legacy_images: "{{ specification.images_to_load[ansible_architecture].legacy }}"

    - name: Load generic and current version images
      vars:
        docker_image: "{{ item }}"
      include_tasks: load-image.yml
      loop: "{{ generic_and_current_images }}"

    - name: Push generic and current version images to registry
      vars:
        docker_image: "{{ item }}"
        new_image_tag: "{{ image_registry_address }}/{{ item.name }}"
      include_tasks: push-image.yml
      loop: "{{ generic_and_current_images }}"

    - name: Load legacy version images to registry when upgrading
      when: is_upgrade_run
      block:
        - name: Load legacy version images
          vars:
            docker_image: "{{ item }}"
          include_tasks: load-image.yml
          loop: "{{ legacy_images }}"

        - name: Push legacy version images to registry
          vars:
            docker_image: "{{ item }}"
            new_image_tag: "{{ image_registry_address }}/{{ item.name }}"
          include_tasks: push-image.yml
          loop: "{{ legacy_images }}"
