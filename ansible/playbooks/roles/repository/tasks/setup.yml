---
- import_tasks: gather-facts.yml

- name: Set mode
  set_fact:
    offline_mode: "{{ offline_requirements | length > 0 }}"

- name: Print mode
  debug:
    var: offline_mode

- name: Set OS name for download script
  set_fact:
    download_requirements_os_name: >-
      {{ 'centos-7' if (ansible_distribution == 'CentOS' and ansible_distribution_major_version == '7') else
          'redhat-7' if (ansible_distribution == 'RedHat' and ansible_distribution_major_version == '7') else
          'ubuntu-20.04' if (ansible_distribution == 'Ubuntu' and ansible_distribution_version == '20.04') else None }}

- name: Set paths for download-requirements script
  set_fact:
    download_requirements_dir: "{{ _download_requirements_dir }}"
    download_requirements_script: "{{ _download_requirements_dir }}/download-requirements.py"
    download_requirements_flag: "{{ _download_requirements_dir }}/download-requirements-done.flag"
  vars:
    _download_requirements_dir: "/var/tmp/epi-download-requirements"

- name: Setup venv and download Epiphany requirements on repository host  # online mode
  block:
    - name: Install required packages for repository
      include_tasks: "RedHat/install-packages.yml"
      when: ansible_os_family == "RedHat"

    - name: Create download-requirements directory
      file:
        path: "{{ download_requirements_dir }}"
        state: directory

    - name: Copy files for downloading requirements to repository host
      synchronize:
        src: download-requirements/
        dest: "{{ download_requirements_dir }}"
        recursive: true
        rsync_opts:
          - "--exclude=tests"  # tests not needed
          - "--exclude=__pycache__"

    - name: Make download script executable
      file:
        dest: "{{ download_requirements_script }}"
        mode: a+x

  when:
    - not offline_mode
    - not custom_repository_url
    - inventory_hostname in target_repository_hostnames

- name: Copy repository client configuration scripts
  copy:
    src: client/{{ ansible_os_family }}/
    dest: /var/tmp/epi-repository-setup-scripts
    mode: a+x

- name: Copy repository server configuration scripts
  copy:
    src: server/{{ ansible_os_family }}/
    dest: /var/tmp/epi-repository-setup-scripts
    mode: a+x
  when:
    - not custom_repository_url
    - inventory_hostname in target_repository_hostnames

- include_tasks: check-whether-to-run-download.yml  # sets 'stat_flag_file'
  when:
    - not offline_mode
    - not custom_repository_url
    - inventory_hostname in target_repository_hostnames

- include_tasks: clean-up-epirepo.yml
  when:
    - is_upgrade_run
    - inventory_hostname in target_repository_hostnames
    - custom_repository_url or
      offline_mode or
      not stat_flag_file.stat.exists  # do not clean up when skipping download
  vars:
    # general paths:
    _reqs_dir: download-requirements/requirements
    _file_reqs_path: "{{ _reqs_dir }}/files.yml"
    _grafana_dashboard_reqs_path: "{{ _reqs_dir }}/grafana_dashboards.yml"
    _image_reqs_path: "{{ _reqs_dir }}/images.yml"

    # target distro files:
    _reqs_distro_dir: "{{ _reqs_dir }}/{{ ansible_architecture }}/{{ ansible_distribution | lower }}"
    _distro_file_reqs_path: "{{ _reqs_distro_dir }}/files.yml"
    _package_reqs_path: "{{ _reqs_distro_dir }}/packages.yml"

    # contents:
    _file_reqs: "{{ lookup('file', _file_reqs_path) | from_yaml }}"
    _grafana_dashboard_reqs: "{{ lookup('file', _grafana_dashboard_reqs_path) | from_yaml }}"
    _image_reqs: "{{ lookup('file', _image_reqs_path) | from_yaml }}"

    _distro_file_reqs: "{{ lookup('file', _distro_file_reqs_path) | from_yaml }}"
    _package_reqs: "{{ lookup('file', _package_reqs_path) | from_yaml }}"

- name: |-
    Copy requirements for offline installation to repository host, this can take a long time
    Destination: {{ specification.apache_epirepo_path }}
  copy:
    src: "{{ offline_requirements }}/"
    dest: "{{ specification.apache_epirepo_path }}"
    force: no # if target exists it will skip, default is 'yes'
  when:
    - offline_mode
    - not custom_repository_url
    - inventory_hostname in target_repository_hostnames

# Put it down here as the script download-requirements.sh relies on some files
# in the folder /var/tmp/epi-repository-setup-scripts that until now it should be available
- name: Download Epiphany requirements
  include_tasks: download-requirements.yml
  when:
    - not offline_mode
    - not custom_repository_url
    - inventory_hostname in target_repository_hostnames
    - not stat_flag_file.stat.exists

- name: Set up repositories
  include_tasks: "{{ ansible_os_family }}/setup.yml"

- name: Include Helm repository creation
  include_tasks: "create-helm-repo.yml"
  when: inventory_hostname == target_repository_hostnames[0]
