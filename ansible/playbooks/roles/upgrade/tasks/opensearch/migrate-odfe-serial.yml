---
# Below tasks need to be run in serial
- name: ODFE migration | Stop Elasticsearch service
  systemd:
    name: elasticsearch
    enabled: false
    state: stopped
  register: elasticsearch_state

- name: ODFE migration | Inastall OpenSearch binaries
  include_tasks: roles/opensearch/tasks/install-opensearch.yml

- name: ODFE migration | Copy Elasticsearch directories to OpenSearch directories
  copy:
    src: "{{ item.1 }}"
    dest: "{{ item.2 }}"
    remote_src: true
    owner: "{{ specification.opensearch_os_user }}"
    group: "{{ specification.opensearch_os_group }}"
    mode: u=rw,go=r
    directory_mode: true
  with_items:
    - {
        1: "/var/lib/elasticsearch-snapshots/",
        2: "{{ specification.paths.opensearch_repo }}/",
      }
    - {
        1: "/var/lib/elasticsearch",
        2: "{{ specification.paths.opensearch_data }}",
      }

- name: ODFE migration | Prepare a list of Elasticsearch certs and keys
  find:
    paths: "/etc/elasticsearch/"
    patterns: "*pem"
  register: pem_files

- name: ODFE migration | Copy a list of certs and keys to OpenSearch directories
  copy:
    src: "{{ item.path }}"
    dest: "{{ specification.paths.opensearch_conf_dir }}/"
    remote_src: true
  with_items: "{{ pem_files.files }}"

- name: ODFE migration | Clone JVM configuration file
  copy:
    src: /etc/elasticsearch/jvm.options
    dest: "{{ specification.paths.opensearch_conf_dir }}/jvm.options"
    remote_src: true
    owner: root
    group: opensearch
    mode: ug=rw,o=
    backup: true

- name: ODFE migration | Update JVM configuration file
  replace:
    path: "{{ specification.paths.opensearch_conf_dir }}/jvm.options"
    regexp: "{{ item.1 }}"
    replace: "{{ item.2 }}"
  with_items:
    - { 1: 'elasticsearch', 2: 'opensearch' }
    - { 1: '\${ES_TMPDIR}', 2: '${OPENSEARCH_TMPDIR}' }

- name: ODFE migration | Clone main configuration file
  copy:
    src: /etc/elasticsearch/elasticsearch.yml
    dest: "{{ specification.paths.opensearch_conf_dir }}/opensearch.yml"
    remote_src: true
    owner: root
    group: opensearch
    mode: ug=rw,o=
    backup: true

- name: ODFE migration | Update main configuration file
  replace:
    path: "{{ specification.paths.opensearch_conf_dir }}/opensearch.yml"
    regexp: "{{ item.1 }}"
    replace: "{{ item.2 }}"
  with_items:
    - { 1: "elasticsearch", 2: "opensearch" }
    - { 1: "EpiphanyElastic", 2: "EpiphanyOpensearch" }
    - { 1: "opendistro_security.", 2: "plugins.security." }

- name: ODFE migration | Start OpenSearch service
  systemd:
    name: opensearch
    state: started
    enabled: true
  register: restart_opensearch

- name: ODFE migration | Wait for OpenSearch to be reachable
  wait_for:
    port: "{{ ports.http }}"
    host: "{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}"
    sleep: 6
