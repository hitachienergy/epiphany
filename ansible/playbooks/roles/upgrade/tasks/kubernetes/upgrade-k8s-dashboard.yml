---
- name: Check if upgrade is needed
  block:
    - name: k8s/master | Include tasks from utils/get-images-from-deployment-template
      include_role:
        name: kubernetes_master
        tasks_from: utils/get-images-from-deployment-template # sets template_images
      vars:
        kind: deployment
        template_file: kubernetes-dashboard.yml.j2

    - name: k8s/master | Include tasks from utils/get-deployment-images
      include_role:
        name: kubernetes_master
        tasks_from: utils/get-deployment-images # sets object_images
      vars:
        kind: deployment
        selector: k8s-app=kubernetes-dashboard
        namespace: kubernetes-dashboard

    - name: k8s/master | Check if Kubernetes Dashboard should be upgraded
      set_fact:
        upgrade_k8s_dashboard: >-
          {{ (template_images | difference(object_images) | count > 0) | ternary(true, false) }}

- name: Upgrade dashboard
  when: upgrade_k8s_dashboard
  block:
    # Force removal is executed as often namespace is in Terminating state
    # The cause issue is the controller manager is using the discovery API to list all available API group/versions,
    # which is hitting the newer apiserver (which tells it about the 'v1' APIs), but when it comes to actually list
    # those resources, it is hitting a different apiserver (running the older version),
    # which means it is unable to list those resources as they donâ€™t exist in the older version.

    # Discovery failed for some groups, 2 failing: unable to retrieve the complete list of server APIs:
    #       certificates.k8s.io/v1: the server could not find the requested resource
    #       events.k8s.io/v1: the server could not find the requested resource
    - name: k8s/master | Delete kubernetes-dashboard namespace
      include_tasks: utils/delete-ns.yml
      vars:
        namespace: kubernetes-dashboard

    # Deploy new version of kubernetes-dashboard
    - name: k8s/master | Apply Kubernetes Dashboard
      include_role:
        name: kubernetes_master
        tasks_from: apply-dashboard
