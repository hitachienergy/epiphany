---
- name: Grafana | Get information about installed packages as facts
  package_facts:
    manager: auto
  when: ansible_facts.packages is undefined

- name: Upgrade Grafana
  when: ansible_facts.packages['grafana'] is defined
  block:
    - name: Get Grafana version vars
      include_vars:
        file: roles/grafana/defaults/versions.yml
        name: grafana_version_vars

    - name: Set Grafana version fact
      set_fact:
        grafana_version: "{{ grafana_version_vars.grafana_version }}"

    - name: Grafana | Print versions
      debug:
        msg:
          - "Installed version: {{ ansible_facts.packages['grafana'][0].version }}"
          - "Target version: {{ grafana_version }}"

    # Since we do not manage custom resources like plugins (it's up to the user), upgrading grafana by just installing new binary is considered complete here.
    # https://grafana.com/docs/grafana/latest/installation/upgrading/
    - name: Grafana | Upgrade
      import_role:
        name: grafana
        tasks_from: install
      when:
        - grafana_version is version(ansible_facts.packages['grafana'][0].version, '>')
