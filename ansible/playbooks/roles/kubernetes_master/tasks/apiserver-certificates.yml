---
- name: Backup apiserver.{crt,key}
  copy:
    dest: "{{ item }}.OLD"
    src: "{{ item }}"
    remote_src: true
  loop:
    - "{{ pki.location }}/apiserver.crt"
    - "{{ pki.location }}/apiserver.key"

- name: Generate new apiserver certificates with kubeadm
  block:
    - name: Delete apiserver.{crt,key}
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ pki.location }}/apiserver.crt"
        - "{{ pki.location }}/apiserver.key"

    - name: Render new certificates apiserver.{crt,key}
      command: |-
        kubeadm init phase certs apiserver \
          --config /etc/kubeadm/kubeadm-config.yml
      args:
        creates: "{{ pki.location }}/apiserver.key"

  rescue:
    - name: Restore apiserver.{crt,key}
      copy:
        dest: "{{ item }}"
        src: "{{ item }}.OLD"
        remote_src: true
      loop:
        - "{{ pki.location }}/apiserver.crt"
        - "{{ pki.location }}/apiserver.key"

    - name: Fail certificates generation
      fail:
        msg: Apiserver certificates generation failed, restored an initial state
