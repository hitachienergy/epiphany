---
- name: Set Postgres Exporter file name to install
  set_fact:
    exporter_file_name: "{{ exporter.file_name[ansible_architecture] }}"

- name: Include upgrade defaults
  include_vars:
    file: defaults/upgrade.yml
    name: upgrade_defaults

- name: Create upgrade state file
  copy:
    dest: "{{ upgrade_defaults.state_file_path }}"
    content: Upgrade started
    mode: u=rw,g=r,o=

- name: Download Postgres Exporter binaries
  include_role:
    name: download
    tasks_from: download_file
  vars:
    file_name: "{{ exporter_file_name }}"

- name: Delete old version
  file:
    state: absent
    path: "/opt/postgres_exporter/postgres_exporter"

- name: Unpack postgres_exporter binary
  become: true
  unarchive:
    remote_src: yes
    src: "{{ download_directory }}/{{ exporter_file_name }}"
    dest: "/opt/postgres_exporter"
    creates: "/opt/postgres_exporter/postgres_exporter"
    extra_opts: [--strip-components=1]
    mode: u=rwx,go=rx
    owner: root
    group: postgres_exporter
  check_mode: false

- name: Configure systemd to use postgres-exporter service
  systemd:
    daemon_reload: yes
    enabled: yes
    name: postgres-exporter.service

- name: Start Postgres exporter
  systemd:
    state: started
    name: postgres-exporter.service

- name: "Remove upgrade state file"
  file:
    path: "{{ upgrade_defaults.state_file_path }}"
    state: absent
