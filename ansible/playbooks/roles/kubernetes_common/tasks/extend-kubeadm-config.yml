---
- name: Assert that update variable is defined
  assert:
    that:
      - update is defined
    fail_msg: Variable 'update' must be defined.

- debug:
    var: update

- name: Collect kubeadm-config
  command: |
    kubectl get configmap kubeadm-config \
      --namespace kube-system \
      --output jsonpath={{ jsonpath }}
  vars:
    jsonpath: >-
      '{.data.ClusterConfiguration}'
  register: kubeadm_config
  changed_when: false

- debug:
    msg:
      - "{{ kubeadm_config }}"


- name: Extend kubeadm config
  set_fact:
    kubeadm_config: >-
      {{ original | combine(update, recursive=true) }}
  vars:
    original: >-
      {{ kubeadm_config.stdout | from_yaml }}

- debug:
    msg:
      - "{{ kubeadm_config }}"

#- name: Pause until you can verify updates to an application were successful
#  ansible.builtin.pause:

- name: Render /etc/kubeadm/kubeadm-config.yml
  copy:
    dest: /etc/kubeadm/kubeadm-config.yml
    mode: u=rw,go=
    backup: yes
    content: >-
      {{ kubeadm_config | to_nice_yaml }}

- name: Merge /etc/kubeadm/kubeadm-config.yml with baseline (2 Kinds) file.
  shell: >-
    cd /etc/kubeadm &&
    sed -n -e '/---/,$p' kubeadm-config.yml.* >> kubeadm-config.yml
  register: result
