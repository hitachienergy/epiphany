---
# This file is meant to be also used by upgrade playbook

- name: Copy configuration file (filebeat.yml)
  template:
    dest: /etc/filebeat/filebeat.yml
    src: filebeat.yml.j2
  register: modify_filebeat_yml

- name: Set Filebeat to be started after Docker
  when: (groups['kubernetes_master'] is defined and inventory_hostname in groups['kubernetes_master'])
     or (groups['kubernetes_node'] is defined and inventory_hostname in groups['kubernetes_node'])
  block:
    - name: Create directory (filebeat.service.d)
      file:
        path: /etc/systemd/system/filebeat.service.d
        state: directory

    - name: Copy drop-in configuration file (extra-dependencies.conf)
      template:
        dest: /etc/systemd/system/filebeat.service.d/extra-dependencies.conf
        src: extra-dependencies.conf.j2
      register: modify_filebeat_unit_dependencies

    - name: Run systemctl daemon-reload
      systemd:
        daemon_reload: true
      when: modify_filebeat_unit_dependencies.changed

- name: Start/restart and enable filebeat service
  when: groups.logging[0] is defined
  block:
    - name: Enable auditd module
      command: filebeat modules enable auditd
      register: enable_module
      changed_when: "'Enabled auditd' in enable_module.stdout"

    - name: Restart filebeat service
      systemd:
        name: filebeat
        state: restarted
      when: modify_filebeat_yml.changed
         or modify_filebeat_unit_dependencies.changed
         or enable_module.changed
         or install_filebeat_package.changed

    - name: Enable and start filebeat service
      systemd:
        name: filebeat
        state: started
        enabled: true

    - name: Wait for filebeat service to be running
      service_facts:
      until:
        - ansible_facts.services['filebeat.service'].state is defined
        - ansible_facts.services['filebeat.service'].state == "running"
      retries: 10
      delay: 1
      no_log: true  # to reduce log output

- name: Stop and disable filebeat service
  systemd:
    name: filebeat
    state: stopped
    enabled: false
  when: groups.logging[0] is undefined
