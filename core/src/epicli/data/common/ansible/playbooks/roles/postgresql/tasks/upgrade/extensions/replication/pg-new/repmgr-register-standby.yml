---
- name: PostgreSQL | Extensions | repmgr | Clone standby node with repmgr
  become_user: postgres
  command: >-
    {{ new_version.repmgr.bin_dir[ansible_os_family] }}/repmgr standby clone
      -h {{ pg_primary_node }}
      -U {{ specification.extensions.replication.privileged_user_name }}
      -d {{ specification.extensions.replication.repmgr_database }} -p 5432 --force

- name: PostgreSQL | Start and enable new PostgreSQL service
  systemd:
    name: "{{ pg.service_name[ansible_os_family] }}"
    state: started
    enabled: true

- name: Extensions | repmgr | Register node with repmgr
  become_user: postgres
  command: >-
    {{ repmgr.bin_dir[ansible_os_family] }}/repmgr standby register --force
      --upstream-conninfo='host={{ pg_primary_node }},
          user={{ specification.extensions.replication.replication_user_name }},
          dbname={{ specification.extensions.replication.repmgr_database }},
          connect_timeout=2'
      --upstream-node-id 1
