---
- name: Extensions | configure PgBouncer
  when: groups.postgresql[0] == inventory_hostname
  block:
    - name: Extensions | PgBouncer | Ensure that systemd service is started
      systemd:
        name: pgbouncer
        state: started

    - name: Extensions | PgBouncer | Change pgbouncer configuration
      lineinfile:
        path: /etc/pgbouncer/pgbouncer.ini
        regexp: "^postgres = host="
        line: postgres = host=127.0.0.1 port=5432 dbname=postgres
        insertafter: '\[databases\]'
        backup: true
      register: db_connection_line

    - name: Extensions | PgBouncer | Change pool mode
      lineinfile:
        path: /etc/pgbouncer/pgbouncer.ini
        regexp: '^pool_mode ='
        line: "pool_mode = transaction"
      register: db_pool_mode_line

    - name: Extensions | PgBouncer | Change pgbouncer users configuration
      lineinfile:
        path: /etc/pgbouncer/userlist.txt
        line: '"postgres" "*"'
        create: true
        mode: u=rw,g=,o=
        owner: "{{ pgbouncer.user[ansible_os_family] }}"
        group: "{{ pgbouncer.group[ansible_os_family] }}"
        backup: true
      register: db_user_line

    - name: Extensions | PgBouncer | Create logrotate configuration file
      template:
        src: logrotate-pgbouncer.conf.j2
        dest: /etc/logrotate.d/pgbouncer
        owner: root
        group: root
        mode: u=rw,go=r

    - name: Extensions | PgBouncer | Restart systemd service
      when: db_connection_line.changed or db_pool_mode_line.changed or db_user_line.changed
      systemd:
        name: pgbouncer
        state: restarted

    - name: Extensions | PgBouncer | Ensure that systemd service is enabled
      systemd:
        name: pgbouncer
        enabled: true
