---
# required vars:
# - es_api.url
# - es_api.cert_path
# - es_api.key_path

- name: ODFE | Wait for the cluster to finish shard allocation
  uri:
    url: "{{ es_api.url }}/_cluster/health"
    method: GET
    client_cert: "{{ es_api.cert_path }}"
    client_key:  "{{ es_api.key_path }}"
    validate_certs: false
  register: cluster_health
  until:
    - cluster_health.json.status is defined
    - cluster_health.json.status == 'green' or
      (cluster_health.json.status == 'yellow' and
       cluster_health.json.initializing_shards == 0 and
       cluster_health.json.relocating_shards == 0)
  retries: 180
  delay: 1
