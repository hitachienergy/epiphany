---
- name: PostgreSQL | Extensions | repmgr | Get latest checkpoint location of primary node
  become_user: postgres
  shell: |-
    set -o pipefail && \
    {{ old_version.pg.bin_dir[ansible_os_family] }}/pg_controldata -D {{ old_version.pg.data_dir[ansible_os_family] }} \
      | awk 'BEGIN{FS=":"} {gsub(/ /,""); if (tolower($1) == "latestcheckpointlocation") print $2}'
  delegate_to: "{{ pg_primary_node }}"
  run_once: true
  changed_when: false
  register: pg_checkpoint

- name: PostgreSQL | Extensions | repmgr | Assert that latest checkpoint location values are the same
  when: inventory_hostname != pg_primary_node
  assert:
    that: hostvars[inventory_hostname]['pg_checkpoint'].stdout == pg_checkpoint.stdout
    fail_msg: "Latest checkpoint location mismatch on hosts {{ inventory_hostname }} and {{ pg_primary_node }}"
    quiet: true
