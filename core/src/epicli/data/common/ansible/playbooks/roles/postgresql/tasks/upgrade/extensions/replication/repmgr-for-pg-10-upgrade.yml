---
# Documentation: https://repmgr.org/docs/5.2/upgrading-repmgr-extension.html#UPGRADING-MAJOR-VERSION#
# Compatibility: https://repmgr.org/docs/5.2/install-requirements.html#INSTALL-COMPATIBILITY-MATRIX

# Expects:
#   - pg_service_names [dict] (list for each OS family)

- name: repmgr for PG 10 | Create upgrade state file
  file:
    path: "{{ upgrade.repmgr.upgrade_state_file_path }}"
    state: touch
    mode: u=rw,g=r,o=

# The upgrade flow masks and unmasks repmgr service so assert it isn't initially masked
- name: repmgr for PG 10 | Populate service facts
  service_facts:

- name: repmgr for PG 10 | Assert repmgr service is not masked
  assert:
    that: ansible_facts.services[_full_service_name].status != 'masked'
    fail_msg: "Unexpected state: service {{ _full_service_name }} is masked"
    quiet: true
  vars:
    _full_service_name: "{{ pg_10.repmgr.service_name[ansible_os_family] + '.service' }}"

- name: repmgr for PG 10 | Ensure repmgr service is started
  systemd:
    name: "{{ pg_10.repmgr.service_name[ansible_os_family] }}"
    state: started
    masked: false  # for re-run after failure

- name: repmgr for PG 10 | Search for primary node
  become_user: postgres
  # command prints primary node name (hostname)
  shell: |-
    set -o pipefail && \
    {{ pg_10.repmgr.bin_dir[ansible_os_family] }}/repmgr cluster show \
      | awk 'BEGIN{FS="|"} {gsub(/ /,""); if ($3 == "primary") print $2}'
  changed_when: false
  register: find_pg_primary_node
  failed_when: find_pg_primary_node.rc != 0 or find_pg_primary_node.stdout == ""
  run_once: true
  args:
    executable: /bin/bash

# Step: Stop repmgr service
- name: repmgr for PG 10 | Stop repmgr service
  systemd:
    name: "{{ pg_10.repmgr.service_name[ansible_os_family] }}"
    state: stopped

# Step: Mask repmgrd service to prevent packages from prematurely restarting repmgr service
- name: repmgr for PG 10 | Mask repmgr service
  systemd:
    name: "{{ pg_10.repmgr.service_name[ansible_os_family] }}"
    masked: true

# Step: Install repmgr packages

# On Ubuntu there is dependent 'repmgr-common' package.
# apt module doesn't support --allow-downgrades (see https://github.com/ansible/ansible/issues/29451)
# so we keep installed version if it's newer.
- name: repmgr for PG 10 | Set target version for repmgr-common package
  set_fact:
    repmgr_common_target_version: >-
      {{ _installed_version is version(target_version, '>') | ternary(_installed_version, target_version + '-*') }}
  when:
    - ansible_os_family == 'Debian'
    - ansible_facts.packages['repmgr-common'] is defined
  vars:
    _installed_version: "{{ ansible_facts.packages['repmgr-common'][0].version }}"

- name: repmgr for PG 10 | Install repmgr package(s)
  package:
    name: "{{ _packages[ansible_os_family] }}"
    state: present
  vars:
    _packages:
      Debian:
        - "{{ repmgr_package_name }}={{ target_version + '-*' }}"
        - repmgr-common={{ repmgr_common_target_version | default(target_version + '-*') }}
      RedHat:
        - "{{ repmgr_package_name }}-{{ target_version }}"
  module_defaults:
    yum: { lock_timeout: "{{ yum_lock_timeout }}" }

# Step: systemctl daemon-reload
# Step: Restart PostgreSQL
- name: repmgr for PG 10 | Restart PostgreSQL service
  systemd:
    name: "{{ service_name }}"
    state: restarted
    daemon_reload: true
  loop_control:
    loop_var: service_name
  loop: "{{ pg_service_names[ansible_os_family] }}"

# Step: Update config file
- name: Update repmgr config file
  block:
    - name: repmgr for PG 10 | Get node id
      command: >-
        sed -n "/^node_id/s/^node_id=//p" "{{ pg_10.repmgr.config_dir[ansible_os_family] }}/repmgr.conf"
      register: pg_node_id
      changed_when: false

    - name: repmgr for PG 10 | Replace repmgr config file
      template:
        src: repmgr.conf.j2
        dest: "{{ pg_10.repmgr.config_dir[ansible_os_family] }}/repmgr.conf"
        owner: postgres
        group: postgres
        mode: u=rw,g=,o=
      vars:
        node_id: "{{ pg_node_id.stdout }}"
        pg_bin_dir: "{{ pg_10.pg.bin_dir[ansible_os_family] }}"
        pg_data_dir: "{{ pg_10.pg.data_dir[ansible_os_family] }}"
        pg_service_name: "{{ pg_10.pg.service_name[ansible_os_family] }}"
        repmgr_service_name: "{{ pg_10.repmgr.service_name[ansible_os_family] }}"
        # TODO: Get specification from manifest
        specification:
          extensions:
            replication:
              replication_user_name: epi_repmgr
              repmgr_database: epi_repmgr

# Step: Execute 'ALTER EXTENSION repmgr UPDATE' (on primary only)
- name: repmgr for PG 10 | Update extension
  become_user: postgres
  postgresql_query:
    # TODO: Get epi_repmgr from manifest
    db: "{{ specification.extensions.replication.repmgr_database | default('epi_repmgr') }}"
    query: ALTER EXTENSION repmgr UPDATE
  when: inventory_hostname == find_pg_primary_node.stdout

# Step: Re-enable repmgr service
- name: repmgr for PG 10 | Re-enable repmgr service
  systemd:
    name: "{{ pg_10.repmgr.service_name[ansible_os_family] }}"
    masked: false
    enabled: true

# Step: Start repmgr service
- name: repmgr for PG 10 | Start repmgr service
  systemd:
    name: "{{ pg_10.repmgr.service_name[ansible_os_family] }}"
    state: started
