---
# =================================================================================================
# Migration from demo certs to generated by Epiphany
# -------------------------------------------------------------------------------------------------
# A) Parallel part (all nodes at the same time) - THIS FILE
#    1. Assert API access using demo cert (done in pre-migration part)
#    2. Generate Epiphany certs           (done in pre-migration part)
#    3. Create dual root CA file for the migration (demo + Epiphany root CAs concatenated), needed temporarily
#    4. Patch the following properties in existing elasticsearch.yml:
#       a) opendistro_security.authcz.admin_dn - add Epiphany admin cert
#       b) opendistro_security.nodes_dn        - by default not present, add all Epiphany node certs
#       c) opendistro_security.ssl.http.pemtrustedcas_filepath      - replace demo root CA with the dual root CA file
#       d) opendistro_security.ssl.transport.pemtrustedcas_filepath - replace demo root CA with the dual root CA file
# B) Serial part (node by node) - tasks from migrate-from-demo-certs-02.yml

# Create dual root CA transitional file
- include_tasks: utils/create-dual-cert-file.yml
  vars:
    certs_to_concatenate:
      - "{{ (certificates.dirs.certs, certificates.files.demo.root_ca.cert)     | path_join }}"
      - "{{ (certificates.dirs.certs, certificates.files.root_ca.cert.filename) | path_join }}"
    target_path: "{{ (certificates.dirs.certs, opendistro_for_elasticsearch.certs_migration.dual_root_ca.filename) | path_join }}"

- name: ODFE | Load /etc/elasticsearch/elasticsearch.yml
  slurp:
    src: /etc/elasticsearch/elasticsearch.yml
  register: _elasticsearch_yml

- name: OFDE | Patch /etc/elasticsearch/elasticsearch.yml (switch to dual root CA)
  copy:
    dest: /etc/elasticsearch/elasticsearch.yml
    content: "{{ _patched_content | to_nice_yaml }}"
    mode: u=rw,g=rw,o=
    owner: root
    group: elasticsearch
    backup: true
  vars:
    _epiphany_subjects:
      admin: "{{ certificates.files.admin.cert.subject }}"
      node:  "{{ certificates.files.node.cert.subject }}"
    _epiphany_dn_attributes:
      admin: "{{ certificates.dn_attributes_order | intersect(_epiphany_subjects.admin.keys()) }}"
      node:  "{{ certificates.dn_attributes_order | intersect(_epiphany_subjects.node.keys()) }}"
    _epiphany_DNs:
      admin: >-
        {{ _epiphany_dn_attributes.admin | zip(_epiphany_dn_attributes.admin | map('extract', _epiphany_subjects.admin))
                                         | map('join','=') | join(',') }}
      node: >-
        {{ _epiphany_dn_attributes.node | zip(_epiphany_dn_attributes.node | map('extract', _epiphany_subjects.node))
                                        | map('join','=') | join(',') }}
    _epiphany_nodes_dn: >-
      {%- for node in ansible_play_hosts_all -%}
        {%- if loop.first -%}[{%- endif -%}
          '{{ _epiphany_DNs.node.split(',') | map('regex_replace', '^CN=.+$', 'CN=' + hostvars[node].ansible_nodename) | join(',') }}'
        {%- if not loop.last -%},{%- else -%}]{%- endif -%}
      {%- endfor -%}
    _old_content: >-
      {{ _elasticsearch_yml.content | b64decode | from_yaml }}
    _updated_settings:
      opendistro_security.authcz.admin_dn: >-
        {{ _old_content['opendistro_security.authcz.admin_dn'] | default([]) | map('replace', ', ', ',')
                                                               | union([opendistro_for_elasticsearch.certs_migration.demo_DNs.admin] + [_epiphany_DNs.admin]) }}
      opendistro_security.nodes_dn: >-
        {{ _old_content['opendistro_security.nodes_dn'] | default([])
                                                        | union([opendistro_for_elasticsearch.certs_migration.demo_DNs.node] + _epiphany_nodes_dn) }}

      opendistro_security.ssl.http.pemtrustedcas_filepath:      "{{ opendistro_for_elasticsearch.certs_migration.dual_root_ca.filename }}"
      opendistro_security.ssl.transport.pemtrustedcas_filepath: "{{ opendistro_for_elasticsearch.certs_migration.dual_root_ca.filename }}"
    _patched_content: >-
      {{ _old_content | combine(_updated_settings) }}
