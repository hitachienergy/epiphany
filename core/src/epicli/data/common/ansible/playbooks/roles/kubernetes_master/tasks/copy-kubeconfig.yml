---
- name: Check if the secrets file exists
  delegate_to: localhost
  become: false
  stat:
    path: "{{ vault_location }}/kubernetes-secrets.yml"
    get_attributes: false
    get_checksum: false
    get_mime: false
  register: stat_kubernetes_secrets_yml

- name: Create kubeconfig
  when: stat_kubernetes_secrets_yml.stat.exists
  become: false
  block:
    - name: Include vars of Kubernetes secrets
      delegate_to: localhost
      include_vars:
        file: "{{ vault_location }}/kubernetes-secrets.yml"
 
    - name: Create kubeconfig file for localhost
      delegate_to: localhost
      template:
        src: kubeconfig.j2
        dest: "{{ inventory_dir }}/admin.conf"
        mode: u=rw,g=,o=
      vars:
        api_server_as_localhost: true

    # Please notice this task file can be executed from other playbooks,
    # hence the fallback "default(groups.kubernetes_master.0)" must be defined.
    - delegate_to: "{{ kubernetes_common.automation_designated_master | default(groups.kubernetes_master.0) }}"
      block:
        - name: Create .kube directory if it does not exist
          file:
            path: "/home/{{ admin_user.name }}/.kube/"
            state: directory

        - name: Create kubeconfig file for server
          template:
            src: kubeconfig.j2
            dest: "/home/{{ admin_user.name }}/.kube/config"
            mode: u=rw,g=,o=
