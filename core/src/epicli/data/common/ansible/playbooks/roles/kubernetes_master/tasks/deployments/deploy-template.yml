---
# This file is meant to be also used by upgrade role

- name: Create directory for files
  become: true
  file:
    path: "{{ epiphany_manifests_dir }}"
    state: directory
    owner: root
    group: root
    mode: u=rwx,go=rx

- name: Upload and apply template
  vars:
    dest_path: "{{ epiphany_manifests_dir }}/{{ file_name | basename | regex_replace('\\.j2$') }}"
  block:
    - name: Upload {{ file_name }} file
      become: true
      template:
        src: "{{ file_name }}"
        dest: "{{ dest_path }}"
        owner: "{{ admin_user.name }}"
        group: "{{ admin_user.name }}"
        mode: u=rw,g=r,o=

    - name: Apply {{ dest_path }} file
      command: kubectl apply -f {{ dest_path }}
      register: kubectl_apply
      changed_when: kubectl_apply.stdout_lines | map('regex_replace', '^.+ ') | reject('eq', 'unchanged') | list
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
